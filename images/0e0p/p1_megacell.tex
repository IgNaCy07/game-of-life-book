\documentclass[10pt]{standalone}
\input{../macros}

\definecolor{darkyellowback}{RGB}{96,96,0}
\definecolor{darkgreenback}{RGB}{0,96,0}
\definecolor{darkmagentaback}{RGB}{96,0,96}
\definecolor{aquaback}{RGB}{192,255,255}
\definecolor{darkaquaback}{RGB}{0,96,96}

\begin{document}
	\begin{tikzpicture}%
		\clip (-6.35,0) rectangle (12,12);
	
		\node[inner sep=0pt,anchor=south west] (ca) at (0.05,0.05) {\includegraphics[width=11.9cm]{p1_megacell.png}};
		
		\draw[color=gray,dashed] (2.72,4.02) -- (2.98,4.28) -- (5.55,1.71) -- (5.29,1.45) --node[rotate=-45,anchor=north,fill=white,fill opacity=0.8,text opacity=1]{\small\texttt{lookup table}} cycle;
		
		% ZOOM
			\newcommand\smlx{3.01}
			\newcommand\smrx{\smlx+0.3}
			\newcommand\smby{3.71}
			\newcommand\smty{\smby+0.3}
			
			\newcommand\bglx{-5.7}
			\newcommand\bgrx{\bglx+4.5}
			\newcommand\bgty{6}
			\newcommand\bgby{\bgty-4.5}
			
			\path[draw,gridgray,line width=0.45pt] (\smlx,\smty) -- (\bglx,\bgty);
			\path[draw,gridgray,line width=0.45pt] (\smlx,\smby) -- (\bglx,\bgby);
			
			\node[inner sep=0pt,anchor=north west] (zoom0) at (\bglx,\bgty) {\includegraphics[width=4.5cm]{p1_megacell_rule.png}};
			
			\path[fill,white,opacity=0.4,line width=0pt] (\smrx,\smty) -- (\bgrx,\bgty) -- (\bgrx,\bgby) -- (\smrx,\smby) -- (\smlx,\smby) -- (\smlx,\smty) -- cycle;
			
			\filldraw[draw=gridgray,fill=white,line width=0.3pt,fill opacity=0.64] (\smlx,\smty) rectangle (\smrx,\smby);
			\draw[gridgray,line width=0.6pt] (\bglx,\bgty) rectangle (\bgrx,\bgby);
			\path[draw,gridgray,line width=0.45pt] (\smrx,\smby) -- (\bgrx,\bgby);
			\path[draw,gridgray,line width=0.45pt] (\smrx,\smty) -- (\bgrx,\bgty);
			
			% Rule labels
			\draw[color=dred!50!white] (\bglx+0.9,\bgty+0.55) node[anchor=north,rotate=45,fill=white,fill opacity=0.8,text opacity=1]{\small\texttt{000000000}};
			
			\newcommand\ruleshft{0.3}
			\draw[color=dred!50!white] (\bglx+0.9+\ruleshft,\bgty+0.55-\ruleshft) node[anchor=north,rotate=45,fill=white,fill opacity=0.8,text opacity=1]{\small\texttt{000000001}};
			
			\renewcommand\ruleshft{0.6}
			\draw[color=dred!50!white] (\bglx+0.9+\ruleshft,\bgty+0.55-\ruleshft) node[anchor=north,rotate=45,fill=white,fill opacity=0.8,text opacity=1]{\small\texttt{000000010}};
			
			\renewcommand\ruleshft{0.9}
			\draw[color=dred!50!white] (\bglx+0.9+\ruleshft,\bgty+0.55-\ruleshft) node[anchor=north,rotate=45,fill=white,fill opacity=0.8,text opacity=1]{\small\texttt{000000011}};
			
			\renewcommand\ruleshft{1.2}
			\draw[color=dred!50!white] (\bglx+0.9+\ruleshft,\bgty+0.55-\ruleshft) node[anchor=north,rotate=45,fill=white,fill opacity=0.8,text opacity=1]{\small\texttt{000000100}};
			
			\renewcommand\ruleshft{1.5}
			\draw[color=dred!50!white] (\bglx+0.9+\ruleshft,\bgty+0.55-\ruleshft) node[anchor=north,rotate=45,fill=white,fill opacity=0.8,text opacity=1]{\small\texttt{000000101}};
			
			\renewcommand\ruleshft{1.8}
			\draw[color=dred!50!white] (\bglx+0.9+\ruleshft,\bgty+0.55-\ruleshft) node[anchor=north,rotate=45,fill=white,fill opacity=0.8,text opacity=1]{\small\texttt{000000110}};
			
			\renewcommand\ruleshft{2.1}
			\draw[color=gray] (\bglx+0.9+\ruleshft,\bgty+0.55-\ruleshft) node[anchor=north,rotate=45,fill=white,fill opacity=0.8,text opacity=1]{\small\texttt{000000111}};
			
			\renewcommand\ruleshft{2.4}
			\draw[color=dred!50!white] (\bglx+0.9+\ruleshft,\bgty+0.55-\ruleshft) node[anchor=north,rotate=45,fill=white,fill opacity=0.8,text opacity=1]{\small\texttt{000001000}};
			
			\renewcommand\ruleshft{2.7}
			\draw[color=dred!50!white] (\bglx+0.9+\ruleshft,\bgty+0.55-\ruleshft) node[anchor=north,rotate=45,fill=white,fill opacity=0.8,text opacity=1]{\small\texttt{000001001}};
			
			\renewcommand\ruleshft{3}
			\draw[color=dred!50!white] (\bglx+0.9+\ruleshft,\bgty+0.55-\ruleshft) node[anchor=north,rotate=45,fill=white,fill opacity=0.8,text opacity=1]{\small\texttt{000001010}};
			
			\renewcommand\ruleshft{3.3}
			\draw[color=gray] (\bglx+0.9+\ruleshft,\bgty+0.55-\ruleshft) node[anchor=north,rotate=45,fill=white,fill opacity=0.8,text opacity=1]{\small\texttt{000001011}};
			
			\renewcommand\ruleshft{3.6}
			\draw[color=dred!50!white] (\bglx+0.9+\ruleshft,\bgty+0.55-\ruleshft) node[anchor=north,rotate=45,fill=white,fill opacity=0.8,text opacity=1]{\small\texttt{000001100}};
			
			\renewcommand\ruleshft{3.9}
			\draw[color=gray] (\bglx+0.9+\ruleshft,\bgty+0.55-\ruleshft) node[anchor=north,rotate=45,fill=white,fill opacity=0.8,text opacity=1]{\small\texttt{000001101}};
			
			\renewcommand\ruleshft{4.2}
			\draw[color=gray] (\bglx+0.84+\ruleshft,\bgty+0.6-\ruleshft) node[anchor=north,rotate=45,fill=white,fill opacity=0.8,text opacity=1,inner sep=1pt]{\small\texttt{$\vdots$}};
		% END ZOOM BOX
		
		\draw[gray] (\bglx+0.41,\bgty+0.07) to[out=135,in=180] (\bglx+0.9,\bgty+5) node[anchor=west,shift={(0,0.02)}]{\texttt{self}};
		
		\draw[gray] (\bglx+0.53,\bgty+0.19) to[out=135,in=180] (\bglx+1.1,\bgty+4.6) node[anchor=west]{\texttt{SE}};
		
		\draw[gray] (\bglx+0.65,\bgty+0.31) to[out=135,in=180] (\bglx+1.3,\bgty+4.2) node[anchor=west]{\texttt{S}};
		
		\draw[gray] (\bglx+0.77,\bgty+0.43) to[out=135,in=180] (\bglx+1.5,\bgty+3.8) node[anchor=west]{\texttt{SW}};
		
		\draw[gray] (\bglx+0.89,\bgty+0.55) to[out=135,in=180] (\bglx+1.7,\bgty+3.4) node[anchor=west]{\texttt{W}};
		
		\draw[gray] (\bglx+1.01,\bgty+0.67) to[out=135,in=180] (\bglx+1.9,\bgty+3) node[anchor=west]{\texttt{NW}};
		
		\draw[gray] (\bglx+1.13,\bgty+0.79) to[out=135,in=180] (\bglx+2.1,\bgty+2.6) node[anchor=west]{\texttt{N}};
		
		\draw[gray] (\bglx+1.25,\bgty+0.91) to[out=135,in=180] (\bglx+2.3,\bgty+2.2) node[anchor=west]{\texttt{NE}};
		
		\draw[gray] (\bglx+1.37,\bgty+1.03) to[out=135,in=180] (\bglx+2.5,\bgty+1.8) node[anchor=west]{\texttt{E}};
		
		%\draw[color=gray] (-3.3,3) node[anchor=north,align=center]{\underline{\texttt{Bit order:}}\\\small\texttt{center, SE, S, SW, W,}\\\small\texttt{{} \ \ \ \ \ \ NW, N, NE, E}};
	\end{tikzpicture}
\end{document}